<!DOCTYPE html>
<html lang="pt-brv">

<head>
    <meta charset="utf-8">
    <title>Rabbit MS</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Favicon -->
    <link href="img/logo.png" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
    <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <div class="container-fluid position-relative d-flex p-0">
        <!-- Spinner Start -->
        <div id="spinner"
            class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->


        <!-- Sidebar Start -->
        <div class="sidebar pe-4 pb-3">
            <nav class="navbar bg-secondary navbar-dark">
                <a href="index.html" class="navbar-brand mx-4 mb-3">
                    <h3 class="text-primary">
                        <img class="nav-logo" src="img/logo.png">
                        </i>Rabbit MS
                    </h3>
                </a>
                <div class="navbar-nav w-100">
                    <a href="index.html" class="nav-item nav-link"><i
                            class="fa fa-tachometer-alt me-2"></i>Dashboard</a>
                    <span id="gestorOnly">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle  " data-bs-toggle="dropdown"><i
                                    class="fa fa-laptop me-2 "></i>Cadastro</a>
                            <div class="dropdown-menu bg-transparent border-0">
                                <a href="add-machine.html" class="dropdown-item">Servidor</a>
                                <a href="add-user.html" class="dropdown-item">Funcionário</a>
                                <a href="add-sector.html" class="dropdown-item">Setor</a>
                            </div>
                        </div>
                        <a href="users.html" class="nav-item nav-link"><i class="fa fa-users me-2"></i>Funcionários</a>
                        <a href="process.html" class="nav-item nav-link"><i class="fa fa-cog me-2"></i>Processos</a>
                        <a href="dados.html" class="nav-item nav-link active"><i
                                class="fa fa-database me-2"></i>Dados</a>
                    </span>
                </div>
            </nav>
        </div>


        <!-- Content Start -->
        <div class="content">
            <span id="spRestrict" style="display: none;">
                <!-- Navbar Start -->
                <nav class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0">
                    <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
                        <h2 class="text-primary mb-0"><i class="fa fa-user-edit"></i></h2>
                    </a>
                    <a href="#" class="sidebar-toggler flex-shrink-0">
                        <i class="fa fa-bars"></i>
                    </a>
                    <div class="navbar-nav align-items-center ms-auto">
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">

                                <span class="d-none d-lg-inline-flex" id="nome"></span>
                            </a>
                            <div
                                class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0">
                                <a href="user-information.html" class="dropdown-item">Dados Pessoais</a>

                                <a onclick="sair()" href="#" class="dropdown-item">Sair</a>
                            </div>
                        </div>
                    </div>
                </nav>
                <!-- Navbar End -->



                <!-- Button trigger modal -->


                <!-- Modal -->
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel" style="color: #5926BB;">Exportar Dados
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                Como deseja exportar os dados ?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-primary" id="generate">Download PDF</button>
                                <button type="button" class="btn btn-primary" onclick="baixarCSV()">Download
                                    CSV</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Sales Start -->
                <div class="container-fluid pt-4 px-4">
                    <div class="bg-secondary text-center rounded p-4">
                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <h6 class="mb-0">Histórico</h6>
                            <form class="form-inline my-2 my-lg-0">
                                <input class="form-control mr-sm-2" type="search" placeholder="Pesquisar"
                                    aria-label="Pesquisar" id="pesquisa" oninput="pesquisando()">
                            </form>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#exampleModal">
                                Exportar
                            </button>

                        </div>
                        <div class="table-responsive">
                            <table id="tabelaTrue"
                                class="table text-start align-middle table-bordered table-hover mb-0">
                                <thead>
                                    <tr class="text-white">
                                        <th scope="col">Horário da
                                            Leitura&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                                        <th scope="col">Pacotes Enviados&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                                        <th scope="col">Pacotes Recebidos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                                        <th scope="col">Bytes Enviados (KB) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                                        <th scope="col">Bytes Recebidos (KB) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela">
                                </tbody>

                            </table>
                        </div>
                    </div>
                </div>


                <div>
                    <canvas style="display:none;" id="myChart"></canvas>
                </div>

                <!-- Footer Start -->
                <div class="container-fluid pt-4 px-4">
                    <div class="bg-secondary rounded-top p-4">
                        <div class="row">
                            <div class="col-12 col-sm-6 text-center text-sm-start">
                                &copy; <a href="#">Rabbit Monitoring System</a>, All Right Reserved.
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Footer End -->
            </span>
        </div>
        <!-- Content End -->



    </div>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/chart/chart.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="../assets/js/funcoes.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    <script>
        verificarAcesso(0);

        var objetoDeCria = {}
        var resultado = obterDados(sessionStorage.USUARIO);
        nome.innerHTML = (resultado.nomeUsuario);
        var idEmpresa = resultado.fkEmpresa;
        const url = new URLSearchParams(window.location.search);
        var idServidor = url.get("idServidor");
        tabelaFuncao(idServidor);
        var csv = 'bytesEnviados,bytesRecebidos,pacotesRecebidos,pacotesEnviadaos,horarioLeitura\n';
        var csvFileData = [];
        var csvFileDataExport = [];


        function baixarCSV() {
            console.log(csvFileDataExport);
            for (let index = 0; index < csvFileDataExport.length; index++) {
                csvFileDataExport[index][4] = csvFileDataExport[index][4].replace(/T/, ' ').replace(/\..+/, '')
            }

            csvFileDataExport.forEach(function (row) {
                csv += row.join(',');
                csv += "\n";
            });
            var hiddenElement = document.createElement('a');
            hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
            hiddenElement.target = '_blank';
            hiddenElement.download = 'Rabbit-Monitoring-System';
            hiddenElement.click();
        }


        async function pesquisando(evt) {
            csvFileDataExport = [];
            var vetorzao = [];
            var procura = await pesquisa.value;
            if (procura != "") {
                const result = csvFileData.filter(word => word.includes(procura))
                if (result != "") {
                    result.forEach(function (vetor) {

                        objeto = {
                            bytesSent: vetor[0],
                            bytesRecv: vetor[1],
                            packetsRecv: vetor[2],
                            packetsSent: vetor[3],
                            horarioLeitura: vetor[4],
                        }
                        vetorzao.push(objeto)
                        csvFileDataExport.push(Object.values(objeto));
                        renderizarTabela(vetorzao)
                    });

                }
            } else {
                tabelaFuncao(idServidor);
            }
        }


        function toString2(obj) {
            Object.keys(obj).forEach(k => {
                obj[k] = '' + obj[k];
            });

            return obj;
        }




        async function tabelaFuncao(id) {
            vetorDeCria=[];
            fetch(`/dadosRede/listarDadosRedeCSV/${id}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        for (let index = 0; index < resposta.length; index++) {
                            tempo = Date.parse(resposta[index].horarioLeitura.replace(/T/, ' ').replace(/\..+/, ''))
                            console.log(tempo);
                            objetoDeCria = {
                                x: tempo,
                                y: resposta[index].bytesRecv
                            }
                            
                           vetorDeCria.push(objetoDeCria)
                        }
                        adicionar(vetorDeCria)
                        resposta.forEach(element => {
                            csvFileData.push(Object.values(Object.values(toString2(element))));
                            csvFileDataExport.push(Object.values(Object.values(toString2(element))));
                        });


                        renderizarTabela(resposta);
                    });
                }
            })
        }

        function renderizarTabela(json) {
            tabela.innerHTML = "";
            for (j in json) {
                valorJson = json[j];
                tabela.innerHTML += `
                                <tr>
                                    <td>${valorJson.horarioLeitura.replace(/T/, ' ').replace(/\..+/, '')}</td>
                                    <td>${valorJson.packetsSent}</td>
                                    <td>${valorJson.packetsRecv}</td>
                                    <td>${valorJson.bytesSent}</td>
                                    <td>${valorJson.bytesRecv}</td>
                                </tr>`
            }

        }

        function detalhes(index) {
            window.location = `./detalhesDados.html?idServidor=${index}`;
        }

        var myModal = document.getElementById('myModal')
        var myInput = document.getElementById('myInput')

        myModal.addEventListener('shown.bs.modal', function () {
            myInput.focus()
        })









    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.3.2/jspdf.debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.2.3/jspdf.plugin.autotable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        function adicionar(obj) {
            console.log(obj);
            const ctx = document.getElementById('myChart')
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                    datasets: [{
                        label: '# of Votes',
                        data: obj,
                        borderWidth: 1,
                        categoryPercentage: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'linear',
                            offset: false,
                            grid: {
                                offset: false
                            },
                            ticks: {
                                stepSize: 3
                            },
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        },
                        y: {
                            //beginAtZero: true
                            title: {
                                display: true,
                                text: 'Visitantes'
                            }
                        }
                    },
                    plugins: {
                        leggend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    if (!items.length) {
                                        return '';
                                    }
                                    const item = items[0];
                                    const x = item.parsed.x;
                                    const min = x - 0.5;
                                    const max = x + 0.5;
                                    return `${min} - ${max}`;
                                }
                            }
                        }
                    }
                }
            });
        }



        var elem = document.getElementById("generate");
        elem.onclick = function () {





            const canvas = document.getElementById('myChart')
            const canvasImage = canvas.toDataURL('image')

            var doc = new jsPDF();
            doc.text(30, 20, `Histórico da Rede do Servidor ${idServidor} - Rabbit Monitoring System`);
            doc.autoTable({
                margin: { top: 30 },
                html: '#tabelaTrue',
                columnStyles: {
                    5: { cellWidth: 40 }
                },
                bodyStyles: {
                    minCellHeight: 10
                },
            });
            //doc.addPage('a4', "portrait")
            //doc.text(75, 20, "Overflow 'ellipsize' (default)");
            //doc.addImage(canvasImage, 'JPEG', 15, 30, 185, 100)
            doc.save('Rabbit-Monitoring-System.pdf');
        };
    </script>


    </script>
</body>

</html>